<!doctype html>
<html>
    <head>
        <style>
            .body,
            .wrapper {
            /* Break the flow */
            background-color: black;
            position: absolute;
            top: 0px;

            /* Give them all the available space */
            width: 100%;
            height: 100%;

            /* Remove the margins if any */
            margin: 0;

            /* Allow them to scroll down the document */
            overflow-y: hidden;
            }

            .body {
            /* Sending body at the bottom of the stack */
            z-index: 1;
            }

            .wrapper {
            /* Making the wrapper stack above the body */
            z-index: 2;
            }
        </style>
    </head>

<body class="body">
<div class="wrapper">
<div id="contentwrapper">
<button id="toggle" onclick="btntoggle()" style="padding:20px;">Pause</button>
<button onclick="reset()" style="padding:20px;">Reset</button>
<button id="AItoggle" onclick="AItoggle()" style="padding:20px;">AI Off</button>
<canvas id="field" width="625" height="625" style="margin:auto;display:block;border: 2px solid white"></canvas>
<div id="data" style="margin-left:0;display:flex;">
    <h1 id="score" style="color:white;margin-left:30vw;margin-right:10vw;font-family:Cambria, Cochin, Georgia, Times, 'Times New Roman', serif">Score: 0</h1>
    <h1 id="level" style="color:white;margin-right:10vw;font-family:Cambria, Cochin, Georgia, Times, 'Times New Roman', serif">Level: 1</h1>
</div>
</div>
<script>

// LEVEL DETAILS
let levelSet = {
    1: {
        speed: 2,
        enemies: 0,
        wall: 0,
        goal: 50
    },
    2: {
        speed: 1.2,
        enemies: 0,
        wall: 1,
        goal: 100
    },
    3: {
        speed: 1,
        enemies: 1,
        wall: 1,
        goal: 140
    },
    4: {
        speed: .1,
        wall: 0,
        goal: 200
    },
    5: {
        speed: .8,
        wall: 1,
        goal: 250
    }
}

    var level = 1;
    var gameon = true;
    var AI = false;
    score = 0;

    xvel = 1;
    yvel = 0;
    xpos = ypos = 5;
    gxpos = gypos = 15;

    tlength = [];
    tail = 4;

    grid = tc = 25;

    // LOAD FUNCTION
    window.onload = function()
    {
        canvas = document.getElementById("field");
        context = canvas.getContext("2d");
        scoreTF = document.getElementById("score");
        levelTF = document.getElementById("level");
        toggleBtn = document.getElementById("toggle");
        AIBtn = document.getElementById("AItoggle");
        document.addEventListener("keydown", keyPress);
        interval = setInterval(play, 60*levelSet[level].speed);
    }

    // MAIN
    function play()
    {
        if(AI == true)
        {
            AIrun();
        }

        xpos += xvel;
        ypos += yvel;

        if(levelSet[level].wall == 1)
        {
            if(xpos < 0 || xpos > tc - 1 || ypos < 0 || ypos > tc - 1)
            {
                reset();
            }
        }
        else
        {
            if(xpos<0)
                xpos = tc-1;
            if(xpos>tc-1)
                xpos = 0;
            if(ypos<0)
                ypos = tc-1;
            if(ypos>tc-1)
                ypos = 0;
        }
        
        tlength.push({x:xpos, y:ypos});
        while(tlength.length>tail)
        {
            tlength.shift();
        }

        context.fillStyle = "black";
        context.fillRect(0, 0, canvas.width, canvas.height);

        context.fillStyle = "white";
        for(var i=0;i<tlength.length;i++)
        {
            if(i != tlength.length-1 && tlength[i].x==xpos && tlength[i].y == ypos)
                reset();

            context.fillRect(tlength[i].x*grid, tlength[i].y*grid,grid-2,grid-2);     
        }

        if(xpos == gxpos && ypos == gypos)
        {
            tail++;
            score += 10;
            gxpos = Math.floor(Math.random()*tc);
            gypos = Math.floor(Math.random()*tc);
        }

        if(levelSet[level].wall == 1)
            canvas.style.border = '20px solid white';
        else
            canvas.style.border = '2px solid white';

        scoreTF.textContent= "Score: " + score;

        context.fillStyle="red";
        context.fillRect(gxpos*grid,gypos*grid,grid-1,grid-1);

        if(score >= levelSet[level].goal)
        {
            levelUp();
        }
    }

    // LEVEL UP
    function levelUp()
    {
        console.log("Level: " + level);
        console.log("Level set length: " + Object.keys(levelSet).length);
        console.log(levelSet);
        if(level<Object.keys(levelSet).length)
            level++;
        console.log("Level: " + level);

        clearInterval(interval);
        interval = setInterval(play, 60*levelSet[level].speed);
        levelTF.textContent= "Level: " + level;
    }

    // MOVEMENT CONTROLS
    function keyPress(key)
    {
        if(AI == false)
        {
            switch(key.keyCode)
            {
                case 37:    //LEFT
                    xvel = -1;
                    yvel = 0;
                    break;
                case 38:    //UP
                    xvel = 0;
                    yvel = -1;
                    break;
                case 39:    //RIGHT
                    xvel = 1;
                    yvel = 0;
                    break;
                case 40:    //DOWN
                    xvel = 0;
                    yvel = 1;
                    break;
            }
        }
    }

    // RESET
    function reset()
    {
        level = 1;
        score = 0;
        tail = 4;
        if(gameon==false)
            btntoggle();
        clearInterval(interval);
        interval = setInterval(play, 60*levelSet[level].speed);
        levelTF.textContent= "Level: " + level;
    }

    // PAUSE TOGGLE
    function btntoggle()
    {
        if(gameon == true)
        {
            clearInterval(interval);
            toggleBtn.textContent= "Resume";
            gameon = false;
        }
        else
        {
            interval = setInterval(play, 60*levelSet[level].speed);
            toggleBtn.textContent= "Pause";
            gameon = true;
        }
    }

    function AItoggle()
    {
        if(AI == true)
        {
            AI = false;
            AIBtn.textContent= "AI Off";
        }
        else
        {
            AI = true;
            AIBtn.textContent= "AI On";
        }
    }

    function AIrun()
    {
        console.log("X: " + gxpos);
        console.log("Y: " + gypos);


        if(xpos != gxpos)
        {
            yvel = 0;
            if(xpos < gxpos)
            {
                xvel = 1;
                for(var i=0;i<tlength.length;i++)
                {
                    if(i != tlength.length-1 && tlength[i].x==xpos+1 && tlength[i].y == ypos)
                    {
                        xvel = 0
                        for(var i=0;i<tlength.length;i++)
                        {
                            yvel = 1;
                            if(i != tlength.length-1 && tlength[i].x==xpos && tlength[i].y+1 == ypos)
                            {
                                yvel = -1;
                            }
                        }
                    }
                }
            }
            else if(xpos > gxpos)
            {
                xvel = -1;
                for(var i=0;i<tlength.length;i++)
                {
                    if(i != tlength.length-1 && tlength[i].x==xpos-1 && tlength[i].y == ypos)
                    {
                        xvel = 0
                        for(var i=0;i<tlength.length;i++)
                        {
                            yvel = 1;
                            if(i != tlength.length-1 && tlength[i].x==xpos && tlength[i].y+1 == ypos)
                            {
                                yvel = -1;
                            }
                        }
                    }
                }
            }
            else
                xvel = 0;
        }
        else
        {
            xvel = 0;
            if(ypos < gypos)
            {
                yvel = 1;
                for(var i=0;i<tlength.length;i++)
                {
                    if(i != tlength.length-1 && tlength[i].y==ypos+1 && tlength[i].x == xpos)
                    {
                        yvel = 0
                    }
                }
            }
            else if(ypos > gypos)
                yvel = -1;
            else
                yvel = 0;
        }
        

        
    }

    // MOBILE MOVEMENT LISTENERS
    document.addEventListener('touchstart', function(e){
        var touch = e.changedTouches[0]
        startX = touch.pageX
        startY = touch.pageY
    }, false)

    document.addEventListener('touchmove', function(e){}, false)

    document.addEventListener('touchend', function(e){
    var touch = e.changedTouches[0]
    distX = touch.pageX - startX
    distY = touch.pageY - startY

    if (Math.abs(distX) > Math.abs(distY)) {
      if (distX > 0 && xvel === 0) {
        xvel = 1;
        yvel = 0;
      }
      else if (distX < 0 && xvel === 0) {
        xvel = -1;
        yvel = 0;
      }
    } else {
      if (distY > 0 && yvel === 0) {
        yvel = 1;
        xvel = 0;
      }
      else if (distY < 0 && yvel === 0) {
        yvel = -1;
        xvel = 0;
      }
    }
    }, false)
</script>
</div>
</body>