<!doctype html>
<html>
    <head>
        <style>
            .body,
            .wrapper {
            /* Break the flow */
            position: absolute;
            top: 0px;

            /* Give them all the available space */
            width: 100%;
            height: 100%;

            /* Remove the margins if any */
            margin: 0;

            /* Allow them to scroll down the document */
            overflow-y: hidden;
            }

            .body {
            /* Sending body at the bottom of the stack */
            z-index: 1;
            }

            .wrapper {
            /* Making the wrapper stack above the body */
            z-index: 2;
            }
        </style>
    </head>

<body class="body">
<div class="wrapper">
<canvas id="field" width="400" height="400" style="margin-left:40vw"></canvas>
<div style="display:flex;">
<h1 id="score" style="margin-left:40vw;font-family:Cambria, Cochin, Georgia, Times, 'Times New Roman', serif">Score: 0</h1>
<h1 id="level" style="margin-left:8vw;font-family:Cambria, Cochin, Georgia, Times, 'Times New Roman', serif">Level: 1</h1>
</div>
<script>

let levelSet = {
    1: {
        speed: 2,
        enemies: 0,
        wall: 0,
        goal: 50
    },
    2: {
        speed: 1.2,
        enemies: 0,
        wall: 1,
        goal: 100
    },
    3: {
        speed: 1,
        enemies: 1,
        wall: 1,
        goal: 140
    },
    4: {
        speed: .1,
        goal: 200
    }
}

    var level = 1;

    window.onload = function()
    {
        canvas = document.getElementById("field");
        context = canvas.getContext("2d");
        scoreTF = document.getElementById("score");
        levelTF = document.getElementById("level");
        document.addEventListener("keydown", keyPress);
        interval = setInterval(play, 60*levelSet[level].speed);
        //load();
    }

    xvel = yvel = 0;
    xpos = ypos = 5;
    gxpos = gypos = 15;

    tlength = [];
    tail = 4;

    grid = tc = 20;

    score = 0;

    function play()
    {
        xpos += xvel;
        ypos += yvel;

        if(xpos<0)
            xpos = tc-1;
        if(xpos>tc-1)
            xpos = 0
        if(ypos<0)
            ypos = tc-1;
        if(ypos>tc-1)
            ypos = 0
        
        tlength.push({x:xpos, y:ypos});
        while(tlength.length>tail)
        {
            tlength.shift();
        }

        context.fillStyle = "black";
        context.fillRect(0, 0, canvas.width, canvas.height);

        context.fillStyle = "white";
        for(var i=0;i<tlength.length;i++)
        {
            if(i != tlength.length-1 && tlength[i].x==xpos && tlength[i].y == ypos)
            {
                tail = 4;
                score = 0;
            }
            context.fillRect(tlength[i].x*grid, tlength[i].y*grid,grid-1,grid-1);     
        }

        if(xpos == gxpos && ypos == gypos)
        {
            tail++;
            score += 10;
            gxpos = Math.floor(Math.random()*tc);
            gypos = Math.floor(Math.random()*tc);
        }

        
        scoreTF.textContent= "Score: " + score;

        context.fillStyle="red";
        context.fillRect(gxpos*grid,gypos*grid,grid-1,grid-1);

        if(score >= levelSet[level].goal)
        {
            levelUp();
        }
    }

    function levelUp()
    {
        console.log("Level: " + level);
        console.log("Level set length: " + Object.keys(levelSet).length);
        console.log(levelSet);
        if(level<Object.keys(levelSet).length)
            level++;
        console.log("Level: " + level);
        //score = 0;
        tail = 4;

        clearInterval(interval);
        interval = setInterval(play, 60*levelSet[level].speed);
        levelTF.textContent= "Level: " + level;
    }

    function keyPress(key)
    {
        switch(key.keyCode)
        {
            case 37:    //LEFT
                xvel = -1;
                yvel = 0;
                break;
            case 38:    //UP
                xvel = 0;
                yvel = -1;
                break;
            case 39:    //RIGHT
                xvel = 1;
                yvel = 0;
                break;
            case 40:    //DOWN
                xvel = 0;
                yvel = 1;
                break;
        }
    }

    document.addEventListener('touchstart', function(e){
        var touch = e.changedTouches[0]
        startX = touch.pageX
        startY = touch.pageY
        e.preventDefault()
    }, false)

    document.addEventListener('touchmove', function(e){
        e.preventDefault()
    }, false)

    document.addEventListener('touchend', function(e){
    var touch = e.changedTouches[0]
    distX = touch.pageX - startX
    distY = touch.pageY - startY

    if (Math.abs(distX) > Math.abs(distY)) {
      if (distX > 0 && xvel === 0) {
        xvel = 1;
        yvel = 0;
      }
      else if (distX < 0 && xvel === 0) {
        xvel = -1;
        yvel = 0;
      }
    } else {
      if (distY > 0 && yvel === 0) {
        yvel = 1;
        xvel = 0;
      }
      else if (distY < 0 && yvel === 0) {
        yvel = -1;
        xvel = 0;
      }
    }
    e.preventDefault();
    }, false)
</script>
</div>
</body>